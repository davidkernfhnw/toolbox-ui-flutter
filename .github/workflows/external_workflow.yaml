name: External Github Action Flow (triggerred from other repositories)
on:
  workflow_dispatch:

jobs:
  unit-test:
    name: -> Unit tests on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        # os: [ubuntu-18.04, windows-2019, macos-10.15]
        os: [ubuntu-18.04]
    # runs-on: ubuntu-latest
    # container:
    #   image:  google/dart:latest
    steps:
    # Get the source code
    - name: -> Get the source code
      uses: actions/checkout@v2
    # Create keystore file
    - name: -> Decode the keystore
      id: decode_keystore
      uses: timheuer/base64-to-file@v1
      with:
        fileName: 'keystore.jks'
        encodedString: ${{ secrets.KEY_JKS }}
    - name: -> Relocate the keystore file
      run: cp ${{steps.decode_keystore.outputs.filePath}} android/
    # Set up Flutter.
    - name: -> Setup Flutter environment
      uses: subosito/flutter-action@v1
      with:
        channel: stable
    - name: -> Check the flutter environment
      run: flutter doctor -v

    # Install the dependencies
    - name: -> Get packages
      run: flutter pub get
    # Update the latest version of Geiger packages
    - name: -> Update the latest version of geiger packages - geiger_localstorage/...
      run: flutter pub upgrade geiger_localstorage

    # Analyze, check formatting, and run unit tests.
    - name: -> Analyze the project
      run: flutter analyze
    - name: -> Check the format
      run: flutter format --set-exit-if-changed --dry-run .
    # Run the unit tests
    - name: -> Run unit tests
      run: flutter test
    # Generate the apk file
    - name: -> Generate apk file
      env:
        KEY_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        ALIAS_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      run: flutter build apk --release
    # Upload the artifact
    - name: -> Upload the generated .apk file
      uses: actions/upload-artifact@v2
      with:
        name: release-apk
        path: build/app/outputs/flutter-apk/app-release.apk

    # Trigger other to test the application
    # - name: -> Trigger the external_workflows on other repositories
    #   run: |
    #       curl \
    #       -X POST \
    #       -u '${{secrets.USER_NAME}}:${{secrets.APPLICATION_ACCESS_TOKEN}}' \
    #       -H "Accept: application/vnd.github.v3+json" \
    #       https://api.github.com/repos/luongnv89/geiger_toolbox_api_flutter/actions/workflows/main.yaml/dispatches \
    #       -d '{"ref":"refs/heads/main"}'